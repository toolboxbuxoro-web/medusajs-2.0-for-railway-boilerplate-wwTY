# Синхронизация цен из МойСклад

## ✅ Реализовано

Система теперь синхронизирует **розничные цены** из МойСклад в Medusa.

### Как работает

1. **Джоб запускается каждый час** (`0 * * * *`)
2. Получает все товары и их цены через `/report/stock/bystore` endpoint
3. Ищет цену типа **"Розничная цена"** для каждого товара
4. Обновляет цены вариантов в Medusa по SKU

### Конфигурация

По умолчанию используется тип цены **"Розничная цена"**.

Чтобы использовать другой тип цены, установите переменную окружения:

```bash
MOYSKLAD_RETAIL_PRICE_TYPE="Название вашего типа цены"
```

### Файлы

- **Service:** [`src/modules/moysklad/service.ts`](./src/modules/moysklad/service.ts)
  - Метод `retrievePriceTypes()` - получить все типы цен
  - Метод `retrieveAllRetailPrices()` - получить розничные цены для всех товаров
  
- **Job:** [`src/jobs/sync-moysklad-prices.ts`](./src/jobs/sync-moysklad-prices.ts)
  - Запускается каждый час
  - Обновляет цены вариантов в Medusa

### Тестирование

Чтобы посмотреть все типы цен в вашем МойСклад:

```bash
MOYSKLAD_TOKEN=ваш_токен node list-price-types.js
```

## МойСклад API - Типы цен

В МойСклад есть несколько типов цен (Price Types):
- **Цена продажи** (основная цена)
- **Розничная цена** 
- **Оптовая цена**
- И другие пользовательские типы цен

### Структура данных

Endpoint `/report/stock/bystore` возвращает информацию о ценах в поле `salePrices`:

```json
{
  "code": "TOOL123",
  "name": "Шуруповёрт",
  "salePrices": [
    {
      "value": 50000,  // Цена в тыинах (500.00 сум)
      "currency": {
        "meta": { "href": "..." },
        "name": "UZS"
      },
      "priceType": {
        "meta": { 
          "href": "https://api.moysklad.ru/api/remap/1.2/context/companysettings/pricetype/{id}",
          "type": "pricetype" 
        },
        "id": "...",
        "name": "Розничная цена"
      }
    }
  ]
}
```

### Конвертация валюты

- **МойСклад** хранит цены в **минимальных единицах** (тыины для UZS)
  - Пример: 500.00 сум = 50000 (value в API)
  
- **Medusa** также хранит в **минимальных единицах** (tiyin)
  - Пример: 500.00 сум = 50000

При синхронизации:
1. МойСклад возвращает: `value: 50000` (тыины)
2. Конвертируем в сумы: `50000 / 100 = 500.00`
3. Сохраняем в Medusa: `500.00 * 100 = 50000` (тыины)
