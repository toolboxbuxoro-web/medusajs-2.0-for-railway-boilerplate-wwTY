# –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–∫–∞–∑—ã –Ω–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è `completed` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üìã –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã (Payme/Click) –∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–∞ –∑–∞–∫–∞–∑ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ `pending`
- –í –ª–æ–≥–∞—Ö subscriber –≤–∏–¥–Ω–æ: `payment=null (false), fulfillment=null (false)` –¥–∞–∂–µ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, —Ç.–∫. —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç –∑–∞–∫–∞–∑ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞—Ç—å `completed`
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã

---

## üîç –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

### –í Medusa 2.0:

1. **`payment_status` –∏ `fulfillment_status` - –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è**
   - –û–Ω–∏ –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–∞–±–ª–∏—Ü–µ `order`
   - –û–Ω–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –∏–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π:
     - `payment_status` ‚Üê –∏–∑ `payment_collections` ‚Üí `payment_sessions`
     - `fulfillment_status` ‚Üê –∏–∑ `fulfillments`

2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å timing:**
   - –°–æ–±—ã—Ç–∏–µ `order.placed` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
   - –ù–æ `payment_collections` –º–æ–≥—É—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –∑–∞–∫–∞–∑–æ–º
   - –ò–ª–∏ —Å–≤—è–∑–∏ –µ—Å—Ç—å, –Ω–æ `query.graph` –∏—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å:**
   ```
   completeCartWorkflow ‚Üí —Å–æ–∑–¥–∞–µ—Ç order ‚Üí —ç–º–∏—Ç–∏—Ç order.placed
   ‚Üì
   auto-complete-order subscriber –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
   ‚Üì
   query.graph –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å payment_collections
   ‚Üì
   ‚ùå payment_collections = [] –∏–ª–∏ payment_status = null
   ‚Üì
   –ó–∞–∫–∞–∑ –æ—Å—Ç–∞–µ—Ç—Å—è pending
   ```

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω subscriber `auto-complete-order.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –°–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è: `order.placed`, `payment.captured`, `fulfillment.shipped` –∏ –¥—Ä.
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `payment_status` –∏ `fulfillment_status`
- –ï—Å–ª–∏ –æ–±–∞ OK ‚Üí —Å—Ç–∞–≤–∏—Ç `status = "completed"`

**–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```typescript
// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º payment_status –Ω–∞–ø—Ä—è–º—É—é
// 2. –ï—Å–ª–∏ null ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º payment_collections.status
// 3. –ï—Å–ª–∏ null ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º payment_sessions.status
// 4. –ï—Å–ª–∏ null ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º session.data (–¥–ª—è Payme/Click)
//    - Payme: payme_state=2 ‚Üí authorized
//    - Click: click_state="paid" ‚Üí authorized
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ retry

- **–ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥** –¥–ª—è `order.placed` —Å–æ–±—ã—Ç–∏–π
- **Retry –º–µ—Ö–∞–Ω–∏–∑–º**: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥
- –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –¥–∞—Ç—å –≤—Ä–µ–º—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–≤—è–∑–µ–π

### 3. –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ Payme/Click
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 4. –°–æ–∑–¥–∞–Ω—ã fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã

- **–°–∫—Ä–∏–ø—Ç `complete-ready-orders.ts`**: –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ cron
- **Admin endpoint** `/admin/orders/:id/complete`: —Ä—É—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞

---

## ‚ùå –ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –í–µ—Ä–æ—è—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **`query.graph` –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤—è–∑–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ**
   - –í–æ–∑–º–æ–∂–Ω–æ, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ–ª–µ–π –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
   - –ò–ª–∏ —Å–≤—è–∑–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –º–æ–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∞

2. **Payment_collections –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å order**
   - –ü–æ—Å–ª–µ `completeCartWorkflow` payment_collection –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ cart, –∞ –Ω–µ –∫ order
   - –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ Medusa —Å–≤—è–∑—ã–≤–∞–µ—Ç payment_collection —Å order

3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π**
   - –î–∞–∂–µ 5 —Å–µ–∫—É–Ω–¥ + 3 –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
   - –ò–ª–∏ —Å–≤—è–∑–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –Ω–µ —Å–ª—É—à–∞–µ–º

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### 1. –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
```
[auto-complete-order] DEBUG Order {id} query result: payment_collections=?, fulfillments=?, payment_status=?, fulfillment_status=?
[auto-complete-order] DEBUG Payment session data: {...}
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- `payment_collections` > 0? (–µ—Å–ª–∏ 0, –∑–Ω–∞—á–∏—Ç —Å–≤—è–∑–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è)
- –ß—Ç–æ –≤ `payment_sessions.data`? (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `payme_state=2` –∏–ª–∏ `click_state="paid"`)
- –ü–æ—á–µ–º—É `payment_status` –æ—Å—Ç–∞–µ—Ç—Å—è `null`?

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑–∏ –≤ –ë–î:

```sql
-- –ù–∞–π—Ç–∏ payment_collection –¥–ª—è –∑–∞–∫–∞–∑–∞
SELECT pc.*, ps.data
FROM payment_collection pc
JOIN order_payment_collection opc ON opc.payment_collection_id = pc.id
JOIN payment_session ps ON ps.payment_collection_id = pc.id
WHERE opc.order_id = 'order_01KFG6Q2Y06PZAAR14YBMJ6R...'
```

**–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω–µ—Ç –ø—É—Å—Ç–æ:**
- –ó–Ω–∞—á–∏—Ç payment_collection –µ—â–µ –Ω–µ —Å–≤—è–∑–∞–Ω —Å order
- –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏, –∫–∞–∫ Medusa —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö –ø–æ—Å–ª–µ `completeCartWorkflow`

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è:

–ú–æ–∂–µ—Ç –±—ã—Ç—å, –Ω—É–∂–Ω–æ —Å–ª—É—à–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è:
- `payment_collection.created`
- `payment_collection.updated`
- `order.payment_collection_attached` (–µ—Å–ª–∏ —Ç–∞–∫–æ–µ –µ—Å—Ç—å)

---

## üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å query.graph —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π:
```typescript
const { data: orders } = await query.graph({
  entity: "order",
  fields: [
    "id",
    "status",
    "payment_status",
    "fulfillment_status",
    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
    "payment_collections.*",
    "payment_collections.payment_sessions.*",
    "fulfillments.*",
  ],
  filters: { id: orderId },
})
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å

–í–º–µ—Å—Ç–æ `query.graph` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π SQL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è payment_collections:
```typescript
const pgConnection = container.resolve("__pg_connection__")
const result = await pgConnection.raw(`
  SELECT ps.data, ps.status, pc.status as collection_status
  FROM payment_session ps
  JOIN payment_collection pc ON pc.id = ps.payment_collection_id
  JOIN order_payment_collection opc ON opc.payment_collection_id = pc.id
  WHERE opc.order_id = ?
`, [orderId])
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏—è payment_collection

–î–æ–±–∞–≤–∏—Ç—å –≤ subscriber —Å–æ–±—ã—Ç–∏—è:
```typescript
"payment_collection.created",
"payment_collection.updated",
"payment_collection.payment_authorized",
```

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Payment Module API

–í–º–µ—Å—Ç–æ query.graph –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Payment Module –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:
```typescript
const paymentModule = container.resolve(Modules.PAYMENT)
// –ù–∞–π—Ç–∏ payment_collection –¥–ª—è order –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å
```

---

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ Subscriber —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –°—Ç–∞—Ç—É—Å—ã –≤—Å–µ –µ—â–µ `null` –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
- ‚è≥ **–ù—É–∂–Ω—ã –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–î–µ–ø–ª–æ–π —Ç–µ–∫—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π** (—É–∂–µ –∑–∞–ø—É—à–µ–Ω–æ)
2. **–°–æ–±—Ä–∞—Ç—å –ª–æ–≥–∏** —Å DEBUG —Å—Ç—Ä–æ–∫–∞–º–∏
3. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏** –∏ –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É `payment_collections` –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å** –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–∫–∞–∑–µ

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ù–µ —É–ø—Ä–æ—â–∞—Ç—å –ª–æ–≥–∏–∫—É Medusa - —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é
- `status = "completed"` –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
  - `payment_status = "captured"` (–∏–ª–∏ `authorized` –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
  - `fulfillment_status = "fulfilled"` (–∏–ª–∏ `delivered`)
- –ù–æ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–µ–π—Å–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ payment OK –∏ fulfillment –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí —Ç–æ–∂–µ completed
