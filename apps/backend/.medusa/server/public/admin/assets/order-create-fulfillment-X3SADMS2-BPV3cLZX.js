import{g as q}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{g as G}from"./chunk-4XSXVVYD-4qtaglB2.js";import{u as X}from"./chunk-HFB3OQXI-D-mb50b6.js";import{C as D}from"./chunk-2PMSBTXI-BdzS7q8P.js";import{K as B}from"./chunk-6HTZNHPT-VlvzTJFv.js";import{R as N,u as K}from"./chunk-4TC5YS65-DibKdFAA.js";import{a4 as U,ae as W,bk as J,j as e,b as z,e8 as Y,bq as Z,r as T,al as ee,am as ie,af as se,v as V,t as R,w as n,ao as te,B as H,ag as ne,ah as L,ap as le,as as ae,s as re,aj as oe,a7 as ce,by as de,M as me,aT as ue,U as P,I as fe}from"./index-BpfPnGdZ.js";import{u as xe}from"./chunk-GRT22PE5-RHOJWQnO.js";import{S as w}from"./select-BWHoKjkd.js";import{A as $}from"./alert-N-NMZIr-.js";import"./x-mark-mini-hOCHhWa9.js";import"./triangles-mini-MGL63xRf.js";import"./plus-mini-DwCGy8dy.js";import"./prompt-CpsPiMDa.js";import"./check-vtHah2d6.js";var pe=se({quantity:le(L(),ae()),location_id:L(),shipping_option_id:L().optional(),send_notification:ne().optional()});function he({item:t,form:m,locationId:l,reservations:h,disabled:b}){const{t:g}=z(),{variant:f}=oe(t.product_id,t.variant_id,{fields:"*inventory,*inventory.location_levels,*inventory_items"},{enabled:!!t.variant}),{availableQuantity:j,inStockQuantity:E}=T.useMemo(()=>{var a,o,c;if(!((a=f==null?void 0:f.inventory_items)!=null&&a.length)||!((o=f==null?void 0:f.inventory)!=null&&o.length)||!l)return{};const{inventory:p,inventory_items:d}=f;if(!p.every(s=>{var u;return(u=s.location_levels)==null?void 0:u.find(x=>x.location_id===l)}))return{};const _=new Map(d.map(s=>[s.inventory_item_id,s.required_quantity])),y=h==null?void 0:h.find(s=>s.line_item_id===t.id),A=(c=d.find(s=>s.inventory_item_id===(y==null?void 0:y.inventory_item_id)))==null?void 0:c.required_quantity,O=y?(y==null?void 0:y.quantity)/(A||1):0,I=p.map(s=>{var S;const u=(S=s.location_levels)==null?void 0:S.find(Q=>Q.location_id===l),x=_.get(s.id);if(!u||!x)return{availableQuantity:Number.MAX_SAFE_INTEGER,stockedQuantity:Number.MAX_SAFE_INTEGER};const M=u.available_quantity/x,k=u.stocked_quantity/x;return{availableQuantity:M,stockedQuantity:k}}),F=Math.min(...I.map(s=>s.availableQuantity)),i=Math.min(...I.map(s=>s.stockedQuantity));return F===Number.MAX_SAFE_INTEGER||i===Number.MAX_SAFE_INTEGER?{}:{availableQuantity:Math.floor(F+O),inStockQuantity:Math.floor(i)}},[f,l,h]),C=0,r=Math.min(q(t),j||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-row items-center",children:[b&&e.jsx("div",{className:"ml-4 inline-flex items-center",children:e.jsx(ce,{content:g("orders.fulfillment.disabledItemTooltip"),side:"top",children:e.jsx(de,{className:"text-ui-tag-orange-icon"})})}),e.jsxs("div",{className:me("flex flex-1 flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",b&&"pointer-events-none opacity-50"),children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(ue,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(P,{className:"txt-small",as:"span",weight:"plus",children:t.title}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(P,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.variant_title})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:j||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[E||"N/A"," ",E&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",m.getValues(`quantity.${t.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(n.Field,{control:m.control,name:`quantity.${t.id}`,rules:{required:!0,min:C,max:r},render:({field:p})=>e.jsxs(n.Item,{children:[e.jsx(n.Control,{children:e.jsx(fe,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...p,onChange:d=>{const v=d.target.value===""?null:Number(d.target.value);p.onChange(v),isNaN(v)||(v<C||v>r?m.setError(`quantity.${t.id}`,{type:"manual",message:g("orders.fulfillment.error.wrongQuantity",{count:r,number:r})}):m.clearErrors(`quantity.${t.id}`))}})}),e.jsx(n.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",t.quantity," ",g("fields.qty")]})]})]})]})]})})}function ge({order:t,requiresShipping:m}){var I,F;const{t:l}=z(),{handleSuccess:h}=K(),{mutateAsync:b,isPending:g}=Y(t.id),{reservations:f}=Z({line_item_id:t.items.map(i=>i.id),limit:G(t)}),j=X({queryFn:i=>re.admin.stockLocation.list(i),queryKey:["stock_locations"],getOptions:i=>i.stock_locations.map(a=>({label:a.name,value:a.id}))}),[E,C]=T.useState(()=>(t.items||[]).filter(i=>i.requires_shipping===m&&q(i)>0)),r=ee({defaultValues:{quantity:E.reduce((i,a)=>(i[a.id]=q(a),i),{}),send_notification:!t.no_notification},resolver:ie(pe)}),p=V({name:"location_id",control:r.control}),{shipping_options:d=[],isLoading:v}=xe({stock_location_id:p,fields:"+service_zone.fulfillment_set.location.id"}),_=V({name:"shipping_option_id",control:r.control}),y=r.handleSubmit(async i=>{const a=d.find(s=>s.id===_);if(!a){r.setError("shipping_option_id",{type:"manual",message:l("orders.fulfillment.error.noShippingOption")});return}if(!p){r.setError("location_id",{type:"manual",message:l("orders.fulfillment.error.noLocation")});return}let o=Object.entries(i.quantity).map(([s,u])=>({id:s,quantity:u})).filter(({quantity:s})=>!!s);if(m){const s=a==null?void 0:a.shipping_profile_id,u=t.items.reduce((x,M)=>{var k,S,Q;return x[M.id]=(Q=(S=(k=M.variant)==null?void 0:k.product)==null?void 0:S.shipping_profile)==null?void 0:Q.id,x},{});o=o.filter(({id:x})=>u[x]===s)}const c={location_id:p,shipping_option_id:_,no_notification:!i.send_notification,items:o};try{await b(c),R.success(l("orders.fulfillment.toast.created")),h(`/orders/${t.id}`)}catch(s){R.error(s.message)}});T.useEffect(()=>{var i,a;if(d!=null&&d.length){const o=(a=(i=t.shipping_methods)==null?void 0:i[0])==null?void 0:a.shipping_option_id;if(o){const c=d.find(s=>s.id===o);if(c){const s=c.service_zone.fulfillment_set.location.id;r.setValue("location_id",s),r.setValue("shipping_option_id",o||void 0)}}}},[d]);const A=(t.items||[]).map(i=>i.requires_shipping===m&&i.detail.fulfilled_quantity);T.useEffect(()=>{var o;const i=((o=t==null?void 0:t.items)==null?void 0:o.filter(c=>c.requires_shipping===m&&q(c)>0))||[];C(i),i.length?r.clearErrors("root"):r.setError("root",{type:"manual",message:l("orders.fulfillment.error.noItems")});const a=i.reduce((c,s)=>(c[s.id]=q(s),c),{});r.setValue("quantity",a)},[...A,m]);const O=_&&((F=(I=t.shipping_methods)==null?void 0:I[0])==null?void 0:F.shipping_option_id)!==_;return e.jsx(N.Form,{form:r,children:e.jsxs(B,{onSubmit:y,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(n.Field,{control:r.control,name:"location_id",render:({field:{...i}})=>e.jsxs(n.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(n.Label,{children:l("fields.location")}),e.jsx(n.Hint,{children:l("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(n.Control,{children:e.jsx(D,{...i,options:j.options,searchValue:j.searchValue,onSearchValueChange:j.onSearchValueChange,disabled:j.disabled})})})]}),e.jsx(n.ErrorMessage,{})]})})}),e.jsxs("div",{className:"py-8",children:[e.jsx(n.Field,{control:r.control,name:"shipping_option_id",render:({field:{onChange:i,ref:a,...o}})=>e.jsxs(n.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(n.Label,{children:l("fields.shippingMethod")}),e.jsx(n.Hint,{children:l("orders.fulfillment.methodDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(n.Control,{children:e.jsxs(w,{onValueChange:i,...o,disabled:!p,children:[e.jsx(w.Trigger,{className:"bg-ui-bg-base",ref:a,children:v?e.jsxs("span",{className:"text-right",children:[l("labels.loading"),"..."]}):e.jsx(w.Value,{})}),e.jsx(w.Content,{children:d.map(c=>e.jsx(w.Item,{value:c.id,children:c.name},c.id))})]})})})]}),e.jsx(n.ErrorMessage,{})]})}),O&&e.jsxs($,{className:"mt-4 p-4",variant:"warning",children:[e.jsx("span",{className:"-mt-[3px] block font-medium",children:l("labels.beaware")}),e.jsx("span",{className:"text-ui-fg-muted",children:l("orders.fulfillment.differentOptionSelected")})]})]}),e.jsxs("div",{children:[e.jsxs(n.Item,{className:"mt-8",children:[e.jsx(n.Label,{children:l("orders.fulfillment.itemsToFulfill")}),e.jsx(n.Hint,{children:l("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:E.map(i=>{var o,c,s,u;const a=((o=d.find(x=>x.id===_))==null?void 0:o.shipping_profile_id)===((u=(s=(c=i.variant)==null?void 0:c.product)==null?void 0:s.shipping_profile)==null?void 0:u.id);return e.jsx(he,{form:r,item:i,locationId:p,disabled:m&&!a,reservations:f},i.id)})})]}),r.formState.errors.root&&e.jsx($,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:r.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(n.Field,{control:r.control,name:"send_notification",render:({field:{onChange:i,value:a,...o}})=>e.jsxs(n.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n.Label,{children:l("orders.returns.sendNotification")}),e.jsx(n.Control,{children:e.jsx(n.Control,{children:e.jsx(te,{checked:!!a,onCheckedChange:i,...o})})})]}),e.jsx(n.Hint,{className:"!mt-1",children:l("orders.fulfillment.sendNotificationHint")}),e.jsx(n.ErrorMessage,{})]})})})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(H,{size:"small",variant:"secondary",children:l("actions.cancel")})}),e.jsx(H,{size:"small",type:"submit",isLoading:g,disabled:!_,children:l("orders.fulfillment.create")})]})})]})})}function Qe(){const{id:t}=U(),[m]=W(),l=m.get("requires_shipping")==="true",{order:h,isLoading:b,isError:g,error:f}=J(t,{fields:"currency_code,*items,*items.variant,+items.variant.product.shipping_profile.id,*shipping_address,+shipping_methods.shipping_option_id"});if(g)throw f;const j=!b&&h;return e.jsx(N,{children:j&&e.jsx(ge,{order:h,requiresShipping:l})})}export{Qe as Component};
