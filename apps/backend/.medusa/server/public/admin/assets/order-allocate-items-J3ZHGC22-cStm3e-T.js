import{g as J}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{K as Y}from"./chunk-6HTZNHPT-VlvzTJFv.js";import{R as N,u as Z}from"./chunk-4TC5YS65-DibKdFAA.js";import{a4 as ee,bk as se,j as e,b as B,r as b,ea as te,al as ae,am as ie,af as le,eb as ne,q as re,bm as oe,t as D,v as P,H as ce,w as f,I as Q,B as H,ap as de,ah as L,as as xe,bn as K,aT as ue,U as R,M as me,bs as fe}from"./index-BpfPnGdZ.js";import{C as ve}from"./component-ijxANTZc.js";import{S as C}from"./select-BWHoKjkd.js";import{A as he}from"./alert-N-NMZIr-.js";import"./prompt-CpsPiMDa.js";import"./check-vtHah2d6.js";import"./triangles-mini-MGL63xRf.js";import"./x-mark-mini-hOCHhWa9.js";var pe=le({location_id:L(),quantity:de(L(),xe().or(L()))});function W(s){const a=s.variant;return a?!!a.inventory_items.length&&a.inventory_items.length>1||a.inventory_items.length===1&&a.inventory_items[0].required_quantity>1:!1}function je({item:s,form:a,locationId:d,onQuantityChange:h}){var _,q,w,$,l,c;const{t:x}=B(),u=s.variant,g=((_=s.variant)==null?void 0:_.inventory)||[],[I,E]=b.useState(!1),m=P({control:a.control,name:"quantity"}),v=W(s),{availableQuantity:o,inStockQuantity:F}=b.useMemo(()=>{var n,t;if(!u||!d)return{};const i=(t=(n=g[0])==null?void 0:n.location_levels)==null?void 0:t.find(r=>r.location_id===d);return i?{availableQuantity:i.available_quantity,inStockQuantity:i.stocked_quantity}:{}},[u,d]),T=!v&&o&&m[`${s.id}-${(q=s.variant)==null?void 0:q.inventory[0].id}`]&&m[`${s.id}-${(w=s.variant)==null?void 0:w.inventory[0].id}`]>o,M=0,p=Math.min(J(s),o||Number.MAX_SAFE_INTEGER);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 min-w-[720px] divide-y divide-dashed rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-x-3 p-3 text-sm",children:[e.jsx("div",{className:"flex flex-1 items-center",children:e.jsxs("div",{className:"flex items-center gap-x-3",children:[T&&e.jsx(K,{className:"text-ui-fg-error"}),e.jsx(ue,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex flex-row",children:[e.jsx(R,{className:"txt-small flex",as:"span",weight:"plus",children:s.product_title}),s.variant_sku&&e.jsxs("span",{className:"text-ui-fg-subtle",children:[" ","(",s.variant_sku,")"]}),v&&e.jsx(ve,{className:"text-ui-fg-muted ml-2 overflow-visible pt-[2px]"})]}),e.jsx(R,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.title})]})]})}),e.jsxs("div",{className:me("flex flex-1 items-center gap-x-3",v?"justify-end":"justify-between"),children:[!v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[o||"-",o&&!v&&m[`${s.id}-${($=s.variant)==null?void 0:$.inventory[0].id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",m[`${s.id}-${(l=s.variant)==null?void 0:l.inventory[0].id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:F||"-"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-row items-center gap-2",children:[e.jsx(f.Field,{control:a.control,name:v?`quantity.${s.id}-`:`quantity.${s.id}-${(c=s.variant)==null?void 0:c.inventory[0].id}`,rules:{required:!v,min:!v&&M,max:p},render:({field:i})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(Q,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...i,disabled:!d,onChange:n=>{var r;const t=n.target.value===""?null:Number(n.target.value);h((r=s.variant)==null?void 0:r.inventory[0],s,v,t,!0)}})})})})," ","/ ",s.quantity," ",x("fields.qty")]})]})]})]}),v&&e.jsx("div",{className:"px-4 py-2",children:e.jsxs("div",{onClick:()=>E(i=>!i),className:"flex items-center gap-x-2",children:[e.jsx(fe,{style:{transform:`rotate(${I?-90:0}deg)`},className:"text-ui-fg-muted -mt-[1px]"}),e.jsx("span",{className:"txt-small text-ui-fg-muted cursor-pointer",children:x("orders.allocateItems.consistsOf",{num:g.length})})]})}),I&&u.inventory.map((i,n)=>{const t=i.location_levels.find(j=>j.location_id===d),r=!!m[`${s.id}-${i.id}`]&&m[`${s.id}-${i.id}`]>t.available_quantity;return e.jsxs("div",{className:"txt-small flex items-center gap-x-3 p-4",children:[e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-3",children:[r&&e.jsx(K,{className:"text-ui-fg-error"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle",children:i.title}),e.jsx("span",{className:"text-ui-fg-muted",children:x("orders.allocateItems.requires",{num:u.inventory_items[n].required_quantity})})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[(t==null?void 0:t.available_quantity)||"-",(t==null?void 0:t.available_quantity)&&m[`${s.id}-${i.id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",m[`${s.id}-${i.id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:(t==null?void 0:t.stocked_quantity)||"-"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-1 flex flex-row items-center gap-2",children:[e.jsx(f.Field,{control:a.control,name:`quantity.${s.id}-${i.id}`,rules:{required:!0,min:0,max:t==null?void 0:t.available_quantity},render:({field:j})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(Q,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...j,disabled:!d,onChange:k=>{const y=k.target.value===""?null:Number(k.target.value);h(i,s,v,y)}})})})}),"/"," ",s.quantity*u.inventory_items[n].required_quantity," ",x("fields.qty")]})]})]})]},i.id)})]})}function ye({order:s}){var q,w,$;const{t:a}=B(),{handleSuccess:d}=Z(),[h,x]=b.useState(!1),[u,g]=b.useState(""),{mutateAsync:I,isPending:E}=te(),m=b.useMemo(()=>s.items.filter(l=>{var c,i;return((c=l.variant)==null?void 0:c.manage_inventory)&&((i=l.variant)==null?void 0:i.inventory.length)&&l.quantity-l.detail.fulfilled_quantity>0}),[s.items]),v=b.useMemo(()=>m.filter(l=>l.variant_title.toLowerCase().includes(u)||l.product_title.toLowerCase().includes(u)),[m,u]);m.length;const o=ae({defaultValues:{location_id:"",quantity:z(m)},resolver:ie(pe)}),{stock_locations:F=[]}=ne(),T=o.handleSubmit(async l=>{try{const c=Object.entries(l.quantity).filter(([t])=>!t.endsWith("-")).map(([t,r])=>[...t.split("-"),r]);if(c.some(t=>t[2]==="")){o.setError("root.quantityNotAllocated",{type:"manual",message:a("orders.allocateItems.error.quantityNotAllocated")});return}const i=c.map(([t,r,j])=>I({location_id:l.location_id,inventory_item_id:r,line_item_id:t,quantity:Number(j)}).then(()=>({success:!0,inventory_item_id:r})).catch(()=>({success:!1,inventory_item_id:r}))),n=await Promise.all(i);if(await re.invalidateQueries({queryKey:oe.details()}),d(`/orders/${s.id}`),n.some(t=>!t.success)){const t=n.filter(r=>!r.success).map(r=>r.inventory_item_id).join(", ");D.error(a("general.error"),{description:a("orders.allocateItems.toast.error",{items:t}),dismissLabel:a("actions.close")})}}catch(c){D.error(a("general.error"),{description:c.message,dismissLabel:a("actions.close")})}}),M=(l,c,i,n,t)=>{var k;let r=!1;const j=t&&i?`quantity.${c.id}-`:`quantity.${c.id}-${l.id}`;if(o.setValue(j,n),n){const y=l.location_levels.find(S=>S.location_id===p);y&&y.available_quantity<n&&(r=!0)}if(i&&!t&&o.resetField(`quantity.${c.id}-`,{defaultValue:""}),i&&t){const y=m.find(S=>S.id===c.id);(k=y.variant)==null||k.inventory_items.forEach((S,G)=>{var V;const U=n||0,A=(V=y.variant)==null?void 0:V.inventory[G];if(o.setValue(`quantity.${c.id}-${A.id}`,U*S.required_quantity),n){const O=A==null?void 0:A.location_levels.find(X=>X.location_id===p);O&&O.available_quantity<n&&(r=!0)}})}o.clearErrors("root.quantityNotAllocated"),x(r)},p=P({name:"location_id",control:o.control});b.useEffect(()=>{p&&o.setValue("quantity",z(m))},[p]);const _=($=(w=(q=o.formState.errors)==null?void 0:q.root)==null?void 0:w.quantityNotAllocated)==null?void 0:$.message;return e.jsx(N.Form,{form:o,children:e.jsxs(Y,{onSubmit:T,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col gap-8 divide-y divide-dashed",children:[e.jsx(ce,{children:a("orders.allocateItems.title")}),e.jsxs("div",{className:"flex-1 divide-y divide-dashed pt-8",children:[e.jsx(f.Field,{control:o.control,name:"location_id",render:({field:{onChange:l,ref:c,...i}})=>e.jsxs(f.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(f.Label,{children:a("fields.location")}),e.jsx(f.Hint,{children:a("orders.allocateItems.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(f.Control,{children:e.jsxs(C,{onValueChange:l,...i,children:[e.jsx(C.Trigger,{className:"bg-ui-bg-base",ref:c,children:e.jsx(C.Value,{})}),e.jsx(C.Content,{children:F.map(n=>e.jsx(C.Item,{value:n.id,children:n.name},n.id))})]})})})]}),e.jsx(f.ErrorMessage,{})]})}),e.jsxs(f.Item,{className:"mt-8 pt-8",children:[e.jsxs("div",{className:"flex flex-row items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(f.Label,{children:a("orders.allocateItems.itemsToAllocate")}),e.jsx(f.Hint,{children:a("orders.allocateItems.itemsToAllocateDesc")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(Q,{value:u,onChange:l=>g(l.target.value),placeholder:a("orders.allocateItems.search"),autoComplete:"off",type:"search"})})]}),_&&e.jsx(he,{className:"mb-4",dismissible:!0,variant:"error",children:_}),e.jsx("div",{className:"flex flex-col gap-y-1",children:v.map(l=>e.jsx(je,{form:o,item:l,locationId:p,onQuantityChange:M},l.id))})]})]})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(H,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(H,{size:"small",type:"submit",isLoading:E,disabled:!p||h,children:a("orders.allocateItems.action")})]})})]})})}function z(s){const a={};return s.forEach(d=>{var x,u;const h=W(d);a[h?`${d.id}-`:`${d.id}-${(x=d.variant)==null?void 0:x.inventory[0].id}`]="",h&&((u=d.variant)==null||u.inventory.forEach(g=>{a[`${d.id}-${g.id}`]=""}))}),a}function Ae(){const{id:s}=ee(),{order:a,isLoading:d,isError:h,error:x}=se(s,{fields:"currency_code,*items,*items.variant,+items.variant.product.title,*items.variant.inventory,*items.variant.inventory.location_levels,*items.variant.inventory_items,*shipping_address"});if(h)throw x;const u=!d&&a;return e.jsx(N,{children:u&&e.jsx(ye,{order:a})})}export{Ae as Component};
