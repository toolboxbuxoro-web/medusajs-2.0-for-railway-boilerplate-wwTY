import{b as J,u as oe,S as re,C as te,a as W}from"./chunk-BVLGW54U-Cqe4EYTU.js";import{C as D,S as ae}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as le}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as q}from"./chunk-HFB3OQXI-D-mb50b6.js";import{C as B}from"./chunk-2PMSBTXI-BdzS7q8P.js";import{D as ce}from"./chunk-Q4ST7H7M-CBSbtt5y.js";import{S as pe}from"./chunk-D7H6ZNK4-fg5EigE4.js";import{c as M}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as de}from"./chunk-6HTZNHPT-VlvzTJFv.js";import{R as w,u as X,a as ue,S as me}from"./chunk-4TC5YS65-DibKdFAA.js";import{a4 as he,ae as ge,bv as fe,aJ as Y,j as e,r as O,b as ee,al as xe,am as _e,af as U,v as ie,fY as je,t as Z,B as A,ap as z,ah as _,s as H,H as ye,U as be,w as n,I as Ce,D as Se,h as ve,l as Oe,m as Pe,ag as we,eU as Le,aq as Q}from"./index-BpfPnGdZ.js";import{b as Ee}from"./chunk-GRT22PE5-RHOJWQnO.js";import{P}from"./progress-tabs-xhh61ah2.js";import{R as G}from"./radio-group-B9dCMRTd.js";import{S as T}from"./select-BWHoKjkd.js";import"./chunk-OSOI7J6Y-BoQHjEVs.js";import"./chunk-Y2RYZS5B-DyMrZ3o1.js";import"./x-mark-mini-hOCHhWa9.js";import"./Trans-CBu9SpTd.js";import"./currency-input-CROLy3x9.js";import"./triangles-mini-MGL63xRf.js";import"./plus-mini-DwCGy8dy.js";import"./_isIndex-CA4sJ4fU.js";import"./adjustments-CM1kR1Ir.js";import"./checkbox-DCa7E6TW.js";import"./prompt-CpsPiMDa.js";import"./index-C0HLiVWt.js";import"./check-vtHah2d6.js";var ke=({form:a,isReturn:g=!1,zone:j,locationId:b,fulfillmentProviderOptions:m,selectedProviderId:x,type:y})=>{const{t}=ee(),p=y==="pickup",d=q({queryFn:i=>H.admin.shippingProfile.list(i),queryKey:["shipping_profiles"],getOptions:i=>i.shipping_profiles.map(s=>({label:s.name,value:s.id}))}),r=q({queryFn:i=>H.admin.shippingOptionType.list(i),queryKey:["shipping_option_types"],getOptions:i=>i.shipping_option_types.map(s=>({label:s.label,value:s.id}))}),u=q({queryFn:i=>H.admin.fulfillmentProvider.list({...i,stock_location_id:b}),queryKey:["fulfillment_providers"],getOptions:i=>i.fulfillment_providers.map(s=>({label:le(s.id),value:s.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(ye,{children:t(`stockLocations.shippingOptions.create.${p?"pickup":g?"returns":"shipping"}.header`,{zone:j.name})}),e.jsx(be,{size:"small",className:"text-ui-fg-subtle",children:t(`stockLocations.shippingOptions.create.${g?"returns":p?"pickup":"shipping"}.hint`)})]}),!p&&e.jsx(n.Field,{control:a.control,name:"price_type",render:({field:i})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(n.Control,{children:e.jsxs(G,{className:"grid grid-cols-1 gap-4 md:grid-cols-2",...i,onValueChange:i.onChange,children:[e.jsx(G.ChoiceBox,{className:"flex-1",value:"flat",label:t("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(G.ChoiceBox,{className:"flex-1",value:"calculated",label:t("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(n.ErrorMessage,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(n.Field,{control:a.control,name:"name",render:({field:i})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("fields.name")}),e.jsx(n.Control,{children:e.jsx(Ce,{...i})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"shipping_profile_id",render:({field:i})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.profile")}),e.jsx(n.Control,{children:e.jsx(B,{...i,options:d.options,searchValue:d.searchValue,onSearchValueChange:d.onSearchValueChange,disabled:d.disabled})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"shipping_option_type_id",render:({field:i})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.type")}),e.jsx(n.Control,{children:e.jsx(B,{...i,options:r.options,searchValue:r.searchValue,onSearchValueChange:r.onSearchValueChange,disabled:r.disabled})}),e.jsx(n.ErrorMessage,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(n.Field,{control:a.control,name:"provider_id",render:({field:i})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{tooltip:t("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:t("stockLocations.shippingOptions.fields.provider")}),e.jsx(n.Control,{children:e.jsx(B,{...i,onChange:s=>{i.onChange(s),a.setValue("fulfillment_option_id","")},options:u.options,searchValue:u.searchValue,onSearchValueChange:u.onSearchValueChange,disabled:u.disabled})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"fulfillment_option_id",render:({field:i})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.fulfillmentOption")}),e.jsx(n.Control,{children:O.createElement(T,{...i,onValueChange:i.onChange,disabled:!x,key:x},e.jsx(T.Trigger,{ref:i.ref,children:e.jsx(T.Value,{})}),e.jsx(T.Content,{children:m==null?void 0:m.filter(s=>!!s.is_return===g).map(s=>e.jsx(T.Item,{value:s.id,children:s.name||s.id},s.id))}))}),e.jsx(n.ErrorMessage,{})]})})]}),e.jsx(Se,{}),e.jsx(pe,{control:a.control,name:"enabled_in_store",label:t("stockLocations.shippingOptions.fields.enableInStore.label"),description:t("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},Te=({form:a,type:g})=>{const j=g==="pickup",{getIsOpen:b,setIsOpen:m}=ue(),[x,y]=O.useState(null),t=l=>{m(D,!0),y(l)},p=()=>{m(D,!1),y(null)},{store:d,isLoading:r,isError:u,error:i}=ve(),s=O.useMemo(()=>{var l;return((l=d==null?void 0:d.supported_currencies)==null?void 0:l.map(S=>S.currency_code))||[]},[d]),{regions:f,isLoading:F,isError:N,error:L}=Oe({fields:"id,name,currency_code",limit:999}),{price_preferences:K}=Pe({}),{setCloseOnEscape:R}=X(),I=ie({control:a.control,name:"name"}),V=oe({name:I,currencies:s,regions:f,pricePreferences:K}),o=r||!d||F||!f,C=O.useMemo(()=>[[...s||[],...f||[]]],[s,f]);if(O.useEffect(()=>{!o&&j&&(s.length>0&&s.forEach(l=>{a.setValue(`currency_prices.${l}`,"0")}),f.length>0&&f.forEach(l=>{a.setValue(`region_prices.${l.id}`,"0")}))},[o,j]),u)throw i;if(N)throw L;return e.jsx(me,{id:D,onOpenChangeCallback:l=>{l||y(null)},children:e.jsx(re,{onOpenConditionalPricesModal:t,onCloseConditionalPricesModal:p,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(ce,{isLoading:o,data:C,columns:V,state:a,onEditingChange:l=>R(!l),disableInteractions:b(D)}),x&&e.jsx(te,{info:x,variant:"create"})]})})})},se=U({name:_().min(1),price_type:Le(ae),enabled_in_store:we(),shipping_profile_id:_().min(1),provider_id:_().min(1),fulfillment_option_id:_().min(1),shipping_option_type_id:_().min(1)}),Fe=U({conditional_region_prices:z(_(),Q(W).optional()),conditional_currency_prices:z(_(),Q(W).optional())}),Ne=U({region_prices:z(_(),_().optional()),currency_prices:z(_(),_().optional())}).merge(se).merge(Fe);function Ie({zone:a,isReturn:g,locationId:j,type:b}){var I,V;const[m,x]=O.useState("details"),[y,t]=O.useState(!1),{t:p}=ee(),{handleSuccess:d}=X(),r=xe({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",fulfillment_option_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:_e(Ne)}),u=ie({control:r.control,name:"provider_id"}),{fulfillment_options:i}=je(u,{enabled:!!u}),s=r.watch("price_type")==="calculated",{mutateAsync:f,isPending:F}=Ee(),N=r.handleSubmit(async o=>{const C=Object.entries(o.currency_prices).map(([c,h])=>{if(h)return{currency_code:c,amount:M(h)}}).filter(c=>!!c),l=Object.entries(o.region_prices).map(([c,h])=>{if(h)return{region_id:c,amount:M(h)}}).filter(c=>!!c),S=Object.entries(o.conditional_region_prices).flatMap(([c,h])=>{const v=(h==null?void 0:h.map(k=>({region_id:c,amount:M(k.amount),rules:J(k)})))||[];return v==null?void 0:v.filter(Boolean)}),E=Object.entries(o.conditional_currency_prices).flatMap(([c,h])=>{const v=(h==null?void 0:h.map(k=>({currency_code:c,amount:M(k.amount),rules:J(k)})))||[];return v==null?void 0:v.filter(Boolean)}),$=[...C,...E,...l,...S],ne=i==null?void 0:i.find(c=>c.id===o.fulfillment_option_id);await f({name:o.name,price_type:o.price_type,service_zone_id:a.id,shipping_profile_id:o.shipping_profile_id,provider_id:o.provider_id,prices:$,data:ne,rules:[{value:g?"true":"false",attribute:"is_return",operator:"eq"},{value:o.enabled_in_store?"true":"false",attribute:"enabled_in_store",operator:"eq"}],type_id:o.shipping_option_type_id},{onSuccess:({shipping_option:c})=>{Z.success(p(`stockLocations.shippingOptions.create.${g?"returns":"shipping"}.successToast`,{name:c.name})),d(`/settings/locations/${j}`)},onError:c=>{Z.error(c.message)}})}),L=o=>{if(o==="pricing"){r.clearErrors();const C=se.safeParse({...r.getValues()});if(!C.success){const[l,...S]=C.error.errors;for(const E of S){const $=E.path.join(".");r.setError($,{message:E.message,type:E.code})}r.setError(l.path.join("."),{message:l.message,type:l.code},{shouldFocus:!0}),t(!1);return}t(!0)}x(o)},K=(I=r.getFieldState("currency_prices"))!=null&&I.isDirty||(V=r.getFieldState("region_prices"))!=null&&V.isDirty||m==="pricing"?"in-progress":"not-started",R=y?"completed":"in-progress";return e.jsx(w.Form,{form:r,children:e.jsx(de,{className:"flex h-full flex-col",onSubmit:N,onKeyDown:o=>{const C=o.key==="Enter",l=o.metaKey||o.ctrlKey,S=m!=="pricing"&&!s;if(C&&(o.preventDefault(),!!l)){if(S){o.stopPropagation(),L("pricing");return}N()}},children:e.jsxs(P,{value:m,className:"flex h-full flex-col overflow-hidden",onValueChange:o=>L(o),children:[e.jsx(w.Header,{children:e.jsxs(P.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(P.Trigger,{value:"details",status:R,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:p("stockLocations.shippingOptions.create.tabs.details")})}),!s&&e.jsx(P.Trigger,{value:"pricing",status:K,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:p("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(ke,{form:r,zone:a,isReturn:g,type:b,locationId:j,fulfillmentProviderOptions:i||[],selectedProviderId:u})}),e.jsx(P.Content,{value:"pricing",className:"size-full",children:e.jsx(Te,{form:r,type:b})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(A,{variant:"secondary",size:"small",children:p("actions.cancel")})}),m==="pricing"||s?e.jsx(A,{size:"small",className:"whitespace-nowrap",isLoading:F,type:"submit",children:p("actions.save")},"submit-btn"):e.jsx(A,{size:"small",className:"whitespace-nowrap",isLoading:F,onClick:()=>L("pricing"),type:"button",children:p("actions.continue")},"continue-btn")]})})]})})})}var Ve="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function pi(){var i,s;const{location_id:a,fset_id:g,zone_id:j}=he(),[b]=ge(),m=b.has("is_return"),{stock_location:x,isPending:y,isFetching:t,isError:p,error:d}=fe(a,{fields:Ve}),r=(i=x==null?void 0:x.fulfillment_sets)==null?void 0:i.find(f=>f.id===g);if(!y&&!t&&!r)throw Y({message:`Fulfillment set with ID ${g} was not found`},404);const u=(s=r==null?void 0:r.service_zones)==null?void 0:s.find(f=>f.id===j);if(!y&&!t&&!u)throw Y({message:`Service zone with ID ${j} was not found`},404);if(p)throw d;return e.jsx(w,{prev:`/settings/locations/${a}`,children:u&&e.jsx(Ie,{zone:u,isReturn:m,locationId:a,type:r.type})})}export{pi as Component};
